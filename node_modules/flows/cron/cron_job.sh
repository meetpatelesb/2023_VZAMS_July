#read the config file
CONFIG_FILE=/home/ushus/dev/dagwood/zz_logistics/metrics/cron/cronjob.config
. $CONFIG_FILE
ToAddress=$ToAddress;
FromAddress=$FromAddress;
Subject=$SUBJECT;
csvpath=$csvpath;
ATTACHMENT=$zippath;
timepath=$metricpath;
nodepath=$nodepath;

function append {
    echo "$2">>$1;
}
#run the node
$nodepath/node $timepath varlog

#zip the csv file
cd $csvpath
zip $csvpath * 
sleep 2
MIMETYPE="application/zip"

# DON'T CHANGE ANYTHING BELOW
TMP="/tmp/tmpfil_123"$RANDOM;
BOUNDARY=`date +%s|md5sum`
BOUNDARY=${BOUNDARY:0:32}
FILENAME='csv.zip'
rm -rf $TMP;
cat $ATTACHMENT|/usr/bin/uuencode --base64 $FILENAME>$TMP;
sed -i -e '1,1d' -e '$d' $TMP;#removes first & last lines from $TMP
DATA=`cat $TMP`
rm -rf $TMP;
append $TMP "From: $FromAddress";
append $TMP "To: $ToAddress";
append $TMP "Reply-To: $FromAddress";
append $TMP "Subject: $Subject";
append $TMP "Content-Type: multipart/mixed; boundary=\""$BOUNDARY"\"";
append $TMP "";
append $TMP "This is a MIME formatted message.  If you see this text it means that your";
append $TMP "email software does not support MIME formatted messages.";
append $TMP "";
append $TMP "--$BOUNDARY";
append $TMP "Content-Type: text/plain; charset=ISO-8859-1; format=flowed";
append $TMP "Content-Transfer-Encoding: 7bit";
append $TMP "Content-Disposition: inline";
append $TMP "";
append $TMP "--$BOUNDARY";
append $TMP "Content-Type: $MIMETYPE; name=\"$FILENAME\"";
append $TMP "Content-Transfer-Encoding: base64";
append $TMP "Content-Disposition: attachment; filename=\"$FILENAME\";";
append $TMP "";
append $TMP "$DATA";
append $TMP "";
append $TMP "";
append $TMP "--$BOUNDARY--";
append $TMP "";
append $TMP "";
#cat $TMP>out.txt
cat $TMP|/usr/sbin/sendmail -t;
rm $TMP;
